<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020408">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Practice Lab v15.0</title>
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Practice%20Lab%22,%22short_name%22:%22Lab%22,%22start_url%22:%22index.html%22,%22display%22:%22standalone%22,%22background_color%22:%22#020408%22,%22theme_color%22:%22#00f2ff%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3293/3293810.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <style>
        :root { --bg: #020408; --card: #0d1117; --accent: #00f2ff; --secondary: #7000ff; --text: #f0f6fc; --border: #30363d; --danger: #f85149; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 15px 15px 100px; }
        
        /* Typography */
        h2 { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }

        /* Modernized Inputs/Lists */
        .grid-select { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .grid-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; cursor: pointer; text-align: center; }
        .grid-btn.active { border-color: var(--accent); background: rgba(0, 242, 255, 0.1); color: var(--accent); }

        .form-group { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid var(--border); margin-bottom: 15px; }
        label { display: block; font-size: 0.65rem; font-weight: 900; color: #8b949e; text-transform: uppercase; margin-bottom: 8px; }
        
        select, input, textarea { width: 100%; background: #161b22; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 10px; appearance: none; }

        /* Action Buttons */
        .btn-action { background: var(--accent); color: black; border: none; width: 100%; padding: 14px; border-radius: 10px; font-weight: 800; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .btn-sub { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-size: 0.7rem; width: 100%; }

        /* Clocks */
        .clock-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .timer-box { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .time-display { font-size: 2.2rem; font-family: monospace; font-weight: bold; margin: 5px 0; }

        /* Drills Detail */
        .drill-card { background: rgba(112, 0, 255, 0.05); border-left: 4px solid var(--secondary); padding: 15px; border-radius: 8px; margin-top: 15px; }
        .drill-title { color: var(--secondary); font-weight: 900; font-size: 0.85rem; margin-bottom: 5px; display: block; }
        .drill-text { font-size: 0.8rem; line-height: 1.5; color: #d1d5db; }

        /* Logs */
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
        .log-meta { font-size: 0.75rem; }
        .log-val { font-weight: bold; color: var(--accent); font-size: 0.9rem; }
        .log-del { color: var(--danger); font-size: 1.2rem; margin-left: 10px; padding: 0 5px; }

        /* Nav */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: #010409; display: flex; border-top: 1px solid var(--border); z-index: 1000; }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: bold; color: #8b949e; }
        .tab.active { color: var(--accent); }

        .screen { display: none; }
        .screen.active { display: block; }

        #needle-container { width: 100%; height: 20px; background: #161b22; border-radius: 10px; position: relative; margin: 20px 0; overflow: hidden; }
        #needle { position: absolute; left: 50%; width: 4px; height: 100%; background: var(--accent); transform: translateX(-50%); transition: 0.1s; }
    </style>
</head>
<body>

<div id="vault" class="screen active">
    <h2>Mission Control</h2>
    
    <label>Select Phase</label>
    <div id="phaseGrid" class="grid-select"></div>

    <label>Active Week</label>
    <div id="weekGrid" class="grid-select"></div>

    <div class="form-group">
        <label>Log Benchmark</label>
        <select id="logType">
            <option>Neural Warmup</option>
            <option>Tech Overload</option>
            <option>Harmonic Intel</option>
            <option>Rhythmic Ctrl</option>
        </select>
        <input type="number" id="logBPM" placeholder="Current BPM">
        <button class="btn-action" onclick="saveLog()">Record Performance</button>
    </div>

    <div id="history"></div>
</div>

<div id="lab" class="screen">
    <h2>Practice Lab</h2>
    
    <div class="clock-row">
        <div class="timer-box">
            <label>Timer</label>
            <div id="tDisp" class="time-display">00:00</div>
            <button class="btn-sub" onclick="resetT()">Reset</button>
        </div>
        <div class="timer-box">
            <label style="color:var(--secondary)">SW</label>
            <div id="swDisp" class="time-display" style="color:var(--secondary)">00:00</div>
            <button class="btn-sub" onclick="resetSW()">Reset</button>
        </div>
    </div>

    <div class="grid-select">
        <button class="grid-btn" onclick="startDrill('Neural Warmup', 5)">Neural</button>
        <button class="grid-btn" onclick="startDrill('Tech Overload', 10)">Tech</button>
        <button class="grid-btn" onclick="startDrill('Harmonic Intel', 8)">Harmonic</button>
    </div>

    <button id="masterBtn" class="btn-action" onclick="toggleClocks()">Start Session</button>

    <div id="drillDetail" class="drill-card" style="display:none;">
        <span id="dtTitle" class="drill-title"></span>
        <div id="dtBody" class="drill-text"></div>
    </div>

    <div class="form-group" style="margin-top:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="bpmTxt" style="font-weight:bold;">120 BPM</span>
            <button onclick="toggleMet()" id="metBtn" class="btn-sub" style="width:80px;">Metronome</button>
        </div>
        <input type="range" min="40" max="250" value="120" oninput="updateBpm(this.value)">
    </div>
</div>

<div id="tuner" class="screen">
    <h2>Pro Tuner</h2>
    <div class="form-group" style="text-align:center; padding: 40px 0;">
        <div id="noteName" style="font-size: 5rem; font-weight: 900; color: var(--accent);">--</div>
        <div id="needle-container"><div id="needle"></div></div>
        <button class="btn-action" id="tuneBtn" onclick="toggleTuning()">Enable Microphone</button>
    </div>
</div>

<div id="config" class="screen">
    <h2>System Config</h2>
    <div class="form-group">
        <label>Gear Notes (Voice)</label>
        <button class="btn-sub" onclick="dictate()" style="margin-bottom:10px;">ðŸŽ¤ Start Dictation</button>
        <textarea id="gearNotes" rows="4"></textarea>
    </div>
    <button class="btn-action" style="background:var(--danger); color:white;" onclick="wipeData()">Reset App Data</button>
</div>

<nav class="tab-bar">
    <div class="tab active" onclick="nav('vault', this)">VAULT</div>
    <div class="tab" onclick="nav('lab', this)">LAB</div>
    <div class="tab" onclick="nav('tuner', this)">TUNER</div>
    <div class="tab" onclick="nav('config', this)">CONFIG</div>
</nav>

<script>
    // --- APP DATA ---
    const drills = {
        "Neural Warmup": "<b>Protocol:</b> High-Precision Neural Pathing. <br><b>Mechanics:</b> Minimize finger lift distance. Aim for < 2mm from the fret wire. Use <i>Zero Force</i>â€”only enough pressure to prevent buzzing.",
        "Tech Overload": "<b>Protocol:</b> Speed Burst Adaptation. <br><b>Mechanics:</b> Downward pick slanting (30Â°). Focus on the escape motion of the pick on string changes. Push 5BPM past your comfort zone for 30s intervals.",
        "Harmonic Intel": "<b>Protocol:</b> Modal visualization. <br><b>Mechanics:</b> Navigate the scale using only 3rds and 7ths. Vocalize the interval name as you strike the string. Connect shapes vertically across the neck.",
        "Rhythmic Ctrl": "<b>Protocol:</b> Subdivision Switching. <br><b>Mechanics:</b> Switch between 8th notes, triplets, and 16ths every 2 bars. Keep the picking hand pendulum constantâ€”never stop the motion even on rests."
    };

    let phases = [
        {name: "Phase 1", start: 1}, {name: "Phase 2", start: 5}, {name: "Phase 3", start: 9},
        {name: "Phase 4", start: 13}, {name: "Phase 5", start: 17}, {name: "Phase 6", start: 21}
    ];

    let state = { phase: 0, week: 1, logs: JSON.parse(localStorage.getItem('lab_logs') || '[]') };

    // --- NAVIGATION & UI ---
    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(isTuning && id !== 'tuner') toggleTuning();
    }

    function initGrids() {
        const pg = document.getElementById('phaseGrid');
        pg.innerHTML = phases.map((p, i) => `<button class="grid-btn ${state.phase === i ? 'active' : ''}" onclick="setPhase(${i})">${p.name}</button>`).join('');
        setPhase(state.phase);
    }

    function setPhase(idx) {
        state.phase = idx;
        initGrids();
        const wg = document.getElementById('weekGrid');
        wg.innerHTML = "";
        for(let i = phases[idx].start; i < phases[idx].start + 4; i++) {
            wg.innerHTML += `<button class="grid-btn ${state.week === i ? 'active' : ''}" onclick="setWeek(${i})">Wk ${i}</button>`;
        }
        renderLogs();
    }

    function setWeek(w) { state.week = w; setPhase(state.phase); }

    // --- LOGS ---
    function saveLog() {
        const bpm = document.getElementById('logBPM').value;
        if(!bpm) return;
        state.logs.unshift({ id: Date.now(), wk: state.week, type: document.getElementById('logType').value, bpm: bpm });
        localStorage.setItem('lab_logs', JSON.stringify(state.logs));
        renderLogs();
    }

    function delLog(id) {
        state.logs = state.logs.filter(l => l.id !== id);
        localStorage.setItem('lab_logs', JSON.stringify(state.logs));
        renderLogs();
    }

    function renderLogs() {
        const h = document.getElementById('history');
        h.innerHTML = state.logs.slice(0, 5).map(l => `
            <div class="log-item">
                <div class="log-meta">Wk ${l.wk} â€¢ ${l.type}</div>
                <div style="display:flex; align-items:center;">
                    <span class="log-val">${l.bpm} BPM</span>
                    <span class="log-del" onclick="delLog(${l.id})">Ã—</span>
                </div>
            </div>
        `).join('');
    }

    // --- WORKOUT ENGINE ---
    let tRem = 0, swSec = 0, clockIv, active = false;
    function startDrill(name, mins) {
        tRem = mins * 60;
        document.getElementById('dtTitle').innerText = name;
        document.getElementById('dtBody').innerHTML = drills[name];
        document.getElementById('drillDetail').style.display = 'block';
        updateClockUI();
    }

    function toggleClocks() {
        active = !active;
        if(active) {
            clockIv = setInterval(() => { if(tRem > 0) tRem--; swSec++; updateClockUI(); }, 1000);
            document.getElementById('masterBtn').innerText = "Pause Session";
        } else {
            clearInterval(clockIv);
            document.getElementById('masterBtn').innerText = "Resume Session";
        }
    }

    function updateClockUI() {
        const f = (s) => Math.floor(s/60).toString().padStart(2, '0') + ":" + (s%60).toString().padStart(2, '0');
        document.getElementById('tDisp').innerText = f(tRem);
        document.getElementById('swDisp').innerText = f(swSec);
    }
    function resetT() { tRem = 0; updateClockUI(); }
    function resetSW() { swSec = 0; updateClockUI(); }

    // --- METRONOME ---
    let mCtx, mOn = false, mBpm = 120, mNext = 0, mIv;
    function updateBpm(v) { mBpm = v; document.getElementById('bpmTxt').innerText = v + " BPM"; }
    function toggleMet() {
        if(!mCtx) mCtx = new AudioContext();
        mOn = !mOn;
        if(mOn) { mNext = mCtx.currentTime; mTick(); } else clearTimeout(mIv);
    }
    function mTick() {
        while(mNext < mCtx.currentTime + 0.1) {
            const o = mCtx.createOscillator(); const g = mCtx.createGain();
            o.frequency.value = 800; g.gain.exponentialRampToValueAtTime(0.5, mNext);
            g.gain.exponentialRampToValueAtTime(0.001, mNext + 0.05);
            o.connect(g); g.connect(mCtx.destination); o.start(mNext); o.stop(mNext + 0.05);
            mNext += 60 / mBpm;
        }
        mIv = setTimeout(mTick, 25);
    }

    // --- TUNER (Autocorrelation) ---
    let tCtx, tAnalys, tStream, isTuning = false;
    async function toggleTuning() {
        const btn = document.getElementById('tuneBtn');
        if(!isTuning) {
            tCtx = new AudioContext();
            tStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const src = tCtx.createMediaStreamSource(tStream);
            tAnalys = tCtx.createAnalyser(); tAnalys.fftSize = 2048;
            src.connect(tAnalys); isTuning = true;
            btn.innerText = "Stop Tuner"; btn.style.background = "var(--danger)";
            runTuner();
        } else {
            tStream.getTracks().forEach(t => t.stop()); tCtx.close(); isTuning = false;
            btn.innerText = "Enable Microphone"; btn.style.background = "var(--accent)";
        }
    }

    function runTuner() {
        if(!isTuning) return;
        let buf = new Float32Array(2048); tAnalys.getFloatTimeDomainData(buf);
        let freq = (function(buf, sr) {
            let SIZE = buf.length, rms = 0;
            for(let i=0; i<SIZE; i++) rms += buf[i]*buf[i];
            if(Math.sqrt(rms/SIZE)<0.01) return -1;
            let c = new Float32Array(SIZE);
            for(let j=0; j<SIZE; j++) for(let i=0; i<SIZE-j; i++) c[j] += buf[i]*buf[i+j];
            let d=0; while(c[d]>c[d+1]) d++;
            let maxv=-1, maxp=-1;
            for(let i=d; i<SIZE; i++) if(c[i]>maxv) { maxv=c[i]; maxp=i; }
            return sr/maxp;
        })(buf, tCtx.sampleRate);

        if(freq !== -1) {
            let note = 12 * (Math.log(freq/440)/Math.log(2)) + 69;
            let names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            document.getElementById('noteName').innerText = names[Math.round(note)%12];
            let diff = (note - Math.round(note)) * 50;
            document.getElementById('needle').style.left = (50 + diff) + "%";
        }
        requestAnimationFrame(runTuner);
    }

    // --- PWA & CONFIG ---
    function dictate() {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.start(); rec.onresult = (e) => { document.getElementById('gearNotes').value += e.results[0][0].transcript + " "; };
    }
    function wipeData() { if(confirm("Erase everything?")) { localStorage.clear(); location.reload(); } }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,' + btoa("self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));"));
    }

    initGrids();
</script>
</body>
</html>
