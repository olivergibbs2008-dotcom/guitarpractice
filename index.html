<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Practice Lab: Omni-Architect</title>
    <style>
        :root { --bg: #030508; --glass: rgba(15, 20, 30, 0.95); --accent: #00f2ff; --secondary: #7000ff; --text: #e0e6ed; --muted: #64748b; --danger: #ff4757; --success: #2ed573; --border: rgba(0, 242, 255, 0.2); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 10px 10px 110px; line-height: 1.5; }
        .container { max-width: 480px; margin: 0 auto; }
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border-radius: 24px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .custom-label { font-size: 0.65rem; font-weight: 900; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; display: block; }
        select, input, textarea { width: 100%; background: #0a0f18; border: 2px solid var(--border); color: var(--text); padding: 14px; border-radius: 16px; font-size: 1rem; margin-bottom: 12px; transition: 0.2s; outline: none; }
        
        /* Tab Navigation */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 85px; background: rgba(5, 8, 12, 0.98); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { color: var(--muted); font-size: 0.6rem; font-weight: 800; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; }
        .tab-icon { font-size: 1.5rem; margin-bottom: 4px; opacity: 0.4; }
        .tab-item.active { color: var(--accent); }
        .tab-item.active .tab-icon { opacity: 1; filter: drop-shadow(0 0 5px var(--accent)); }
        
        .screen { display: none; }
        .screen.active { display: block; }

        .btn-primary { background: var(--accent); color: #000; width: 100%; padding: 18px; border-radius: 18px; border: none; font-weight: 900; font-size: 1rem; cursor: pointer; }
        .btn-voice { background: var(--secondary); color: white; border: none; padding: 8px 15px; border-radius: 10px; font-size: 0.7rem; font-weight: 800; margin-bottom: 10px; cursor: pointer; }
        
        /* Heat Map */
        .heatmap { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 10px; }
        .heat-box { width: 18px; height: 18px; border-radius: 3px; background: rgba(255,255,255,0.05); }
        .heat-low { background: #004d4d; }
        .heat-med { background: #009999; }
        .heat-high { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        .timer-val { font-size: 5rem; font-weight: 900; text-align: center; margin: 10px 0; letter-spacing: -3px; }
        #vPrev { width: 100%; border-radius: 20px; display: none; transform: scaleX(-1); margin-top: 10px; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div class="container">

    <div id="vault" class="screen active">
        <h2>Practice <span style="color:var(--accent)">Vault</span></h2>
        <div class="glass-card">
            <span class="custom-label">BPM Progress Heatmap</span>
            <div id="heatmap" class="heatmap"></div>
            <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--muted); margin-top:5px;">
                <span>Week 1</span><span>Week 24</span>
            </div>
        </div>

        <div class="glass-card">
            <span class="custom-label">Log Session</span>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="bpmIn" placeholder="Clean BPM">
                <select id="failTag">
                    <option value="none">Perfect Form</option>
                    <option value="noise">String Noise</option>
                    <option value="sync">Hand Sync</option>
                    <option value="stamina">Stamina</option>
                    <option value="pick">Pick Slant</option>
                </select>
            </div>
            <button class="btn-primary" onclick="logBPM()">SAVE DATA POINT</button>
        </div>
    </div>

    <div id="lab" class="screen">
        <h2>Practice <span style="color:var(--accent)">Lab</span></h2>
        <div class="glass-card" style="text-align:center;">
            <div id="blockLabel" style="font-weight:900; color:var(--muted); font-size:0.7rem;">CHOOSE WORKOUT</div>
            <div class="timer-val" id="timer">00:00</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:15px;">
                <button class="btn-primary" style="padding:10px; font-size:0.7rem;" onclick="startTimer(4, 'Warmup')">Neural 4m</button>
                <button class="btn-primary" style="padding:10px; font-size:0.7rem;" onclick="startTimer(8, 'Overload')">Tech 8m</button>
            </div>
            <button class="btn-primary" id="tBtn" style="margin-top:10px; background:var(--secondary); color:white;" onclick="toggleT()">START TIMER</button>
        </div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="custom-label">Video Analysis</span>
                <button class="btn-voice" onclick="toggleCam()" id="camBtn">Camera</button>
            </div>
            <video id="vPrev" autoplay muted playsinline></video>
        </div>
    </div>

    <div id="tuner" class="screen">
        <h2>Precision <span style="color:var(--accent)">Tuner</span></h2>
        <div class="glass-card" style="text-align:center; padding: 50px 10px;">
            <div id="noteName" style="font-size: 8rem; font-weight: 900; color: var(--accent);">--</div>
            <div style="width:100%; height:12px; background:rgba(255,255,255,0.03); border-radius:6px; position:relative; margin:40px 0; border: 1px solid var(--border); overflow:hidden;">
                <div id="needle" style="position:absolute; left:50%; width:6px; height:100%; background:var(--accent); transition:0.1s; transform: translateX(-50%);"></div>
            </div>
            <button class="btn-primary" id="tuneBtn" onclick="toggleTuner()">ENABLE MIC</button>
        </div>
    </div>

    <div id="write" class="screen">
        <h2>Gear & <span style="color:var(--accent)">Voice</span></h2>
        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="custom-label">Gear Vault / Notes</span>
                <button class="btn-voice" id="voiceBtn" onclick="startSpeech()">üé§ DICTATE</button>
            </div>
            <textarea id="notes" placeholder="Recording signal chain or thoughts..."></textarea>
            <div id="voiceStatus" style="font-size:0.6rem; color:var(--secondary); font-weight:900;"></div>
        </div>
    </div>

    <div id="architect" class="screen">
        <h2>Blueprint <span style="color:var(--accent)">Architect</span></h2>
        <div class="glass-card">
            <select id="editPhaseIdx" onchange="loadPhase()"></select>
            <input type="text" id="editPhaseName" placeholder="Phase Title">
            <textarea id="editPhaseDesc" placeholder="Strategy..."></textarea>
            <input type="text" id="m1" placeholder="Day 1"><input type="text" id="m2" placeholder="Day 2">
            <input type="text" id="m3" placeholder="Day 3"><input type="text" id="m4" placeholder="Day 4">
            <input type="text" id="m5" placeholder="Day 5">
            <button class="btn-primary" style="background:var(--success); color:#000;" onclick="savePhase()">UPDATE SYSTEM</button>
        </div>
    </div>

</div>

<nav class="tab-bar">
    <div class="tab-item active" onclick="nav('vault', this)"><span class="tab-icon">üìä</span>VAULT</div>
    <div class="tab-item" onclick="nav('lab', this)"><span class="tab-icon">üß™</span>LAB</div>
    <div class="tab-item" onclick="nav('tuner', this)"><span class="tab-icon">üéØ</span>TUNER</div>
    <div class="tab-item" onclick="nav('write', this)"><span class="tab-icon">üéôÔ∏è</span>NOTES</div>
    <div class="tab-item" onclick="nav('architect', this)"><span class="tab-icon">üõ†Ô∏è</span>EDIT</div>
</nav>

<script>
    // DATA
    let blueprint = JSON.parse(localStorage.getItem('gtr_omni_bp')) || [
        { name: "Phase 1: Technical Ceiling", desc: "Alt picking focus.", daily: ["Major Scale", "Strict Alt", "Beat-1 Sync", "Triplets", "Review"] },
        { name: "Phase 2: Harmonic Expansion", desc: "Modal fluency.", daily: ["Dorian", "Mixolydian", "Lydian", "Phrygian", "Integration"] },
        { name: "Phase 3: Rhythmic Authority", desc: "Odd groupings.", daily: ["7/8 Feel", "5/4 Groove", "Odd Groups", "Syncopation", "Review"] },
        { name: "Phase 4: Speed Control", desc: "Burst training.", daily: ["Bursts", "Arpeggios", "Sweep", "Maintenance", "Review"] },
        { name: "Phase 5: Modern Rock", desc: "Hybrid picking.", daily: ["Hybrid", "Upper Triads", "Modern Phrasing", "Intervals", "Review"] },
        { name: "Phase 6: Integration", desc: "Composition.", daily: ["Motifs", "Solo Flow", "Dynamics", "Writing", "Final Showcase"] }
    ];

    let bpmData = JSON.parse(localStorage.getItem('gtr_bpm_log')) || [];

    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    // HEATMAP LOGIC
    function drawHeatmap() {
        const container = document.getElementById('heatmap');
        container.innerHTML = '';
        for(let i=0; i<24; i++) {
            const box = document.createElement('div');
            box.className = 'heat-box';
            if(bpmData[i]) {
                if(bpmData[i].bpm > 180) box.classList.add('heat-high');
                else if(bpmData[i].bpm > 120) box.classList.add('heat-med');
                else box.classList.add('heat-low');
            }
            container.appendChild(box);
        }
    }

    function logBPM() {
        const bpm = document.getElementById('bpmIn').value;
        const tag = document.getElementById('failTag').value;
        if(!bpm) return;
        bpmData.push({ bpm: parseInt(bpm), tag: tag, date: new Date() });
        localStorage.setItem('gtr_bpm_log', JSON.stringify(bpmData));
        drawHeatmap();
        alert("Data logged to Vault.");
    }

    // VOICE INTERPRETER
    const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
    if(recognition) {
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = (e) => {
            let transcript = '';
            for(let i = e.resultIndex; i < e.results.length; i++) transcript += e.results[i][0].transcript;
            document.getElementById('notes').value += transcript + " ";
        };
    }

    function startSpeech() {
        if(!recognition) return alert("Speech not supported in this browser.");
        const btn = document.getElementById('voiceBtn');
        if(btn.innerText.includes("DICTATE")) {
            recognition.start();
            btn.innerText = "üõë STOPPING...";
            btn.style.background = "var(--danger)";
            document.getElementById('voiceStatus').innerText = "LISTENING IN REAL TIME...";
        } else {
            recognition.stop();
            btn.innerText = "üé§ DICTATE";
            btn.style.background = "var(--secondary)";
            document.getElementById('voiceStatus').innerText = "";
        }
    }

    // TIMER
    let tRem = 0, tIv;
    function startTimer(m, l) {
        tRem = m * 60; document.getElementById('blockLabel').innerText = l;
        renderT();
    }
    function renderT() {
        const m = Math.floor(tRem/60), s = tRem%60;
        document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
    }
    function toggleT() {
        if(tIv) { clearInterval(tIv); tIv = null; document.getElementById('tBtn').innerText = "RESUME"; }
        else { tIv = setInterval(() => { tRem--; renderT(); if(tRem<=0) clearInterval(tIv); }, 1000); document.getElementById('tBtn').innerText = "PAUSE"; }
    }

    // TUNER
    let tCtx, tAnalys, tData, tStr, tuning = false;
    async function toggleTuner() {
        if(!tuning) {
            tCtx = new AudioContext(); tStr = await navigator.mediaDevices.getUserMedia({ audio: true });
            tCtx.createMediaStreamSource(tStr).connect(tAnalys = tCtx.createAnalyser());
            tAnalys.fftSize = 4096; tData = new Float32Array(tAnalys.frequencyBinCount);
            tuning = true; tTick();
        } else {
            tStr.getTracks().forEach(t => t.stop()); tuning = false;
            document.getElementById('noteName').innerText = "--";
        }
    }
    function tTick() {
        if(!tuning) return;
        tAnalys.getFloatFrequencyData(tData);
        let maxV = -Infinity, maxB = -1;
        for(let i=0; i<tData.length; i++) if(tData[i]>maxV) { maxV=tData[i]; maxB=i; }
        let f = maxB * tCtx.sampleRate / tAnalys.fftSize;
        if(f > 40 && f < 1000 && maxV > -60) {
            let p = 12 * Math.log2(f/440) + 69;
            document.getElementById('noteName').innerText = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][Math.round(p)%12];
            document.getElementById('needle').style.left = (50 + (p-Math.round(p))*50) + "%";
        }
        requestAnimationFrame(tTick);
    }

    // CAM
    let stream;
    async function toggleCam() {
        const v = document.getElementById('vPrev');
        if(!stream) {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            v.srcObject = stream; v.style.display = 'block';
        } else {
            stream.getTracks().forEach(t => t.stop()); stream = null;
            v.style.display = 'none';
        }
    }

    // ARCHITECT
    function initEditor() {
        const s = document.getElementById('editPhaseIdx');
        blueprint.forEach((p,i) => { let o = document.createElement('option'); o.value=i; o.innerText=p.name; s.appendChild(o); });
        loadPhase();
    }
    function loadPhase() {
        const p = blueprint[document.getElementById('editPhaseIdx').value];
        document.getElementById('editPhaseName').value = p.name;
        document.getElementById('editPhaseDesc').value = p.desc;
        p.daily.forEach((d,i) => document.getElementById('m'+(i+1)).value = d);
    }
    function savePhase() {
        const i = document.getElementById('editPhaseIdx').value;
        blueprint[i] = {
            name: document.getElementById('editPhaseName').value,
            desc: document.getElementById('editPhaseDesc').value,
            daily: [1,2,3,4,5].map(n => document.getElementById('m'+n).value)
        };
        localStorage.setItem('gtr_omni_bp', JSON.stringify(blueprint));
        alert("System Updated.");
    }

    drawHeatmap();
    initEditor();
</script>
</body>
</html>
