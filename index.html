<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Practice Lab: v7.0 Pro Studio</title>
    <style>
        :root { --bg: #030508; --glass: rgba(15, 20, 30, 0.96); --accent: #00f2ff; --secondary: #7000ff; --text: #e0e6ed; --muted: #64748b; --danger: #ff4757; --success: #2ed573; --border: rgba(0, 242, 255, 0.2); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 10px 10px 110px; line-height: 1.4; overflow-x: hidden; }
        .container { max-width: 500px; margin: 0 auto; }
        .glass-card { background: var(--glass); backdrop-filter: blur(30px); border-radius: 24px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .header-badge { background: var(--accent); color: #000; padding: 3px 8px; border-radius: 6px; font-size: 0.6rem; font-weight: 900; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }
        .custom-label { font-size: 0.65rem; font-weight: 900; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        select, input, textarea { width: 100%; background: #0a0f18; border: 2px solid var(--border); color: var(--text); padding: 12px; border-radius: 14px; font-size: 0.9rem; margin-bottom: 10px; outline: none; }
        
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 85px; background: rgba(5, 8, 12, 0.98); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { color: var(--muted); font-size: 0.6rem; font-weight: 800; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .tab-item.active { color: var(--accent); }
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .btn-primary { background: var(--accent); color: #000; width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 900; cursor: pointer; }
        .btn-action { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; }
        
        .clock-display { font-size: 4rem; font-weight: 900; text-align: center; font-variant-numeric: tabular-nums; margin: 5px 0; color: white; letter-spacing: -2px; }
        .protocol-box { background: rgba(0,242,255,0.05); border: 1px solid var(--border); border-left: 4px solid var(--accent); padding: 15px; border-radius: 12px; font-size: 0.8rem; line-height: 1.5; color: #cbd5e1; margin-top: 10px; }
        
        .vid-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 15px; background: #000; }
        .vid-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .heatmap { display: grid; grid-template-columns: repeat(12, 1fr); gap: 4px; margin: 10px 0; }
        .heat-box { aspect-ratio: 1; border-radius: 3px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); font-size: 0.5rem; display: flex; align-items: center; justify-content: center; color: #444; }
        .heat-filled { background: var(--accent); color: #000; }
        
        .gallery-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 5px; font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div class="container">

    <div id="vault" class="screen active">
        <h2>Practice Vault <span class="header-badge">v7.0</span></h2>
        
        <div class="glass-card">
            <span class="custom-label">Weekly Progress Roadmap</span>
            <div id="heatmap" class="heatmap"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="bpmIn" placeholder="Max BPM">
                <select id="failIn">
                    <option value="None">No Issues</option>
                    <option value="Sync">Hand Sync</option>
                    <option value="Tension">Muscle Tension</option>
                    <option value="Noise">String Noise</option>
                </select>
            </div>
            <button class="btn-primary" onclick="logSession()">SAVE WEEKLY LOG</button>
        </div>

        <div class="glass-card">
            <span class="custom-label">Recording Gallery</span>
            <div id="galleryList">
                <div style="text-align:center; color:var(--muted); font-size:0.7rem; padding:10px;">No recordings saved yet.</div>
            </div>
        </div>
    </div>

    <div id="lab" class="screen">
        <h2>Practice Lab</h2>
        
        <div class="vid-container">
            <iframe id="phaseVid" src="" frameborder="0" allowfullscreen></iframe>
        </div>

        <div class="glass-card" style="text-align:center;">
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom: -10px;">
                <span class="custom-label" id="timerLabel">COUNTDOWN</span>
                <span class="custom-label" style="color:var(--secondary)">STOPWATCH</span>
            </div>
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <div class="clock-display" id="timerDisp">00:00</div>
                <div style="width:2px; height:40px; background:var(--border);"></div>
                <div class="clock-display" id="swDisp" style="color:var(--secondary); font-size:2.5rem;">00:00</div>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-bottom:15px;">
                <button class="btn-action" onclick="setT(4,'Neural Warmup')">4m</button>
                <button class="btn-action" onclick="setT(8,'Tech Overload')">8m</button>
                <button class="btn-action" onclick="setT(6,'Harmonic Intel')">6m</button>
                <button class="btn-action" onclick="setT(6,'Rhythmic Ctrl')">6m</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <button class="btn-primary" onclick="toggleClocks()">START/STOP</button>
                <button class="btn-action" style="border-color:var(--danger)" onclick="resetClocks()">RESET</button>
                <button class="btn-action" onclick="toggleMet()">METRO</button>
            </div>

            <div id="protocolBox" class="protocol-box">Select an exercise to see the professional execution protocol.</div>
        </div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="bpmVal" style="font-weight:900; color:var(--accent)">120 BPM</span>
                <button class="btn-action" onclick="toggleCam()">REC LENS</button>
            </div>
            <input type="range" min="40" max="250" value="120" oninput="updateBpm(this.value)">
            <video id="vPrev" autoplay muted playsinline style="width:100%; border-radius:15px; display:none; margin-top:10px; transform: scaleX(-1); border:1px solid var(--border);"></video>
            <button id="recBtn" class="btn-primary" style="display:none; margin-top:10px; background:var(--danger); color:white;" onclick="handleRec()">START RECORDING</button>
        </div>
    </div>

    <div id="architect" class="screen">
        <h2>Architect</h2>
        <div class="glass-card">
            <span class="custom-label">Phase Control</span>
            <select id="edPhaseIdx" onchange="loadEditor()"></select>
            <input type="text" id="edName" placeholder="Phase Name">
            <span class="custom-label">Reference Video (YouTube URL)</span>
            <input type="text" id="edVid" placeholder="https://youtube.com/watch?v=...">
            <span class="custom-label">Phase Strategy</span>
            <textarea id="edDesc"></textarea>
            <div id="edDaily"></div>
            <button class="btn-primary" onclick="saveEditor()">UPDATE SYSTEM</button>
        </div>
    </div>

    <div id="notes" class="screen">
        <h2>Notes & Voice</h2>
        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="custom-label">Gear Vault</span>
                <button class="btn-action" id="voiceBtn" onclick="toggleVoice()">ðŸŽ¤ DICTATE</button>
            </div>
            <textarea id="gearVault" placeholder="Signal chain, amp settings..."></textarea>
            <span class="custom-label">General Scratchpad</span>
            <textarea id="scratchNotes" style="height:200px;" placeholder="Tabs, lyrics, session thoughts..."></textarea>
        </div>
    </div>

</div>

<nav class="tab-bar">
    <div class="tab-item active" onclick="nav('vault', this)">VAULT</div>
    <div class="tab-item" onclick="nav('lab', this)">LAB</div>
    <div class="tab-item" onclick="nav('architect', this)">EDIT</div>
    <div class="tab-item" onclick="nav('notes', this)">NOTES</div>
</nav>

<script>
    // --- DATA & PROTOCOLS ---
    const protocols = {
        "Neural Warmup": "<b>Protocol:</b> Play current scales at 50% speed. Keep fingers hovering < 3mm from strings. Use <i>Minimal Movement Principle</i>. Focus on brain-to-fingertip connection.",
        "Tech Overload": "<b>Protocol:</b> Set metronome to 5-10 BPM <i>above</i> your clean limit. Push through physical fatigue while maintaining sync. Log the exact point of mechanical failure.",
        "Harmonic Intel": "<b>Protocol:</b> Navigate the phase's modal map. Target 3rds and 7ths. Use arpeggio enclosures. Visualise the scale intervals rather than patterns.",
        "Rhythmic Ctrl": "<b>Protocol:</b> Practice rhythmic displacement. Move a 4-note motif across the beat (starting on 1, then the 'and', then 2). Focus on the 'Pocket'."
    };

    let blueprint = JSON.parse(localStorage.getItem('gtr_v7_bp')) || [
        { name: "Phase 1: Technical Ceiling", vid: "https://www.youtube.com/embed/P_m9vK_m3Yc", desc: "Strict Alt Picking mechanics.", daily: ["Scale Mapping", "Strict Alt Drills", "Beat-1 Sync", "Triplets", "Recording"] },
        { name: "Phase 2: Harmonic Expansion", vid: "https://www.youtube.com/embed/IDP_Psw0D28", desc: "Modal fluency and visualization.", daily: ["Dorian Paths", "Mixolydian Tones", "Lydian Brightness", "Phrygian Tension", "Integration"] },
        { name: "Phase 3: Rhythmic Authority", vid: "https://www.youtube.com/embed/7X8m3Y-5_z0", desc: "Odd time and displacement.", daily: ["7/8 Feel", "5/4 Groove", "Odd Groupings", "Syncopation", "Review"] },
        { name: "Phase 4: Speed Mastery", vid: "https://www.youtube.com/embed/PaulGilbert_Lesson", desc: "Burst training protocols.", daily: ["Bursts", "Arpeggios", "String Skipping", "Hyper-speed", "Final Video"] }
    ];

    let logs = JSON.parse(localStorage.getItem('gtr_v7_logs')) || {};
    let gallery = JSON.parse(localStorage.getItem('gtr_v7_gallery')) || [];

    // --- NAVIGATION ---
    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(id === 'lab') loadPhaseMedia();
    }

    // --- LAB: CLOCKS & METRONOME ---
    let tRem = 0, swSec = 0, clockIv, clockRunning = false;
    let mCtx, mBpm = 120, mOn = false, mNext = 0, mIv;

    function setT(m, label) {
        tRem = m * 60;
        document.getElementById('timerDisp').innerText = `${m}:00`;
        document.getElementById('protocolBox').innerHTML = protocols[label];
        document.getElementById('timerLabel').innerText = label;
    }

    function toggleClocks() {
        if(!clockRunning) {
            clockRunning = true;
            clockIv = setInterval(() => {
                if(tRem > 0) tRem--;
                swSec++;
                updateClockUI();
            }, 1000);
        } else {
            clearInterval(clockIv);
            clockRunning = false;
        }
    }

    function resetClocks() {
        clearInterval(clockIv);
        clockRunning = false;
        tRem = 0; swSec = 0;
        updateClockUI();
    }

    function updateClockUI() {
        const tm = Math.floor(tRem/60), ts = tRem%60;
        const sm = Math.floor(swSec/60), ss = swSec%60;
        document.getElementById('timerDisp').innerText = `${tm}:${ts<10?'0'+ts:ts}`;
        document.getElementById('swDisp').innerText = `${sm}:${ss<10?'0'+ss:ss}`;
    }

    function toggleMet() {
        if(!mCtx) mCtx = new AudioContext();
        mOn = !mOn;
        if(mOn) { mNext = mCtx.currentTime; mTick(); }
        else clearTimeout(mIv);
    }

    function mTick() {
        while(mNext < mCtx.currentTime + 0.1) {
            const o = mCtx.createOscillator(); const g = mCtx.createGain();
            o.frequency.value = 1000; g.gain.exponentialRampToValueAtTime(1, mNext);
            g.gain.exponentialRampToValueAtTime(0.001, mNext + 0.05);
            o.connect(g); g.connect(mCtx.destination); o.start(mNext); o.stop(mNext + 0.05);
            mNext += 60 / mBpm;
        }
        mIv = setTimeout(mTick, 25);
    }
    function updateBpm(v) { mBpm = v; document.getElementById('bpmVal').innerText = v + " BPM"; }

    // --- VIDEO & GALLERY ---
    let stream, recorder, chunks = [];
    async function toggleCam() {
        const v = document.getElementById('vPrev');
        const rb = document.getElementById('recBtn');
        if(!stream) {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            v.srcObject = stream; v.style.display = 'block'; rb.style.display = 'block';
        } else {
            stream.getTracks().forEach(t => t.stop()); stream = null;
            v.style.display = 'none'; rb.style.display = 'none';
        }
    }

    function handleRec() {
        const rb = document.getElementById('recBtn');
        if(!recorder || recorder.state === 'inactive') {
            chunks = []; recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const name = `Session_${new Date().toLocaleDateString()}_${new Date().toLocaleTimeString()}`;
                gallery.push({ name: name, url: URL.createObjectURL(blob), date: new Date().toLocaleString() });
                localStorage.setItem('gtr_v7_gallery', JSON.stringify(gallery)); // Note: Blobs aren't persistent in LS, but local session works.
                renderGallery();
            };
            recorder.start(); rb.innerText = "STOP RECORDING";
        } else { recorder.stop(); rb.innerText = "START RECORDING"; }
    }

    function renderGallery() {
        const list = document.getElementById('galleryList');
        list.innerHTML = gallery.map((item, i) => `
            <div class="gallery-item">
                <span>${item.name}</span>
                <a href="${item.url}" download="${item.name}.mp4" style="color:var(--accent); text-decoration:none;">DOWNLOAD</a>
            </div>
        `).join('') || '<div style="text-align:center; color:var(--muted); font-size:0.7rem;">No recordings saved.</div>';
    }

    function loadPhaseMedia() {
        // Just an example using phase 0 for logic
        document.getElementById('phaseVid').src = blueprint[0].vid;
    }

    // --- VAULT & HEATMAP ---
    function renderHeatmap() {
        const container = document.getElementById('heatmap');
        container.innerHTML = '';
        for(let i=1; i<=24; i++) {
            const box = document.createElement('div');
            box.className = 'heat-box' + (logs[i] ? ' heat-filled' : '');
            box.innerText = i;
            container.appendChild(box);
        }
    }

    function logSession() {
        const bpm = document.getElementById('bpmIn').value;
        const fail = document.getElementById('failIn').value;
        if(!bpm) return;
        // Auto-increment week logic for demo
        const week = Object.keys(logs).length + 1;
        logs[week] = { bpm, fail };
        localStorage.setItem('gtr_v7_logs', JSON.stringify(logs));
        renderHeatmap();
    }

    // --- ARCHITECT EDITOR ---
    function initEditor() {
        const sel = document.getElementById('edPhaseIdx');
        sel.innerHTML = blueprint.map((p,i) => `<option value="${i}">${p.name}</option>`).join('');
        loadEditor();
    }
    function loadEditor() {
        const p = blueprint[document.getElementById('edPhaseIdx').value];
        document.getElementById('edName').value = p.name;
        document.getElementById('edVid').value = p.vid;
        document.getElementById('edDesc').value = p.desc;
        document.getElementById('edDaily').innerHTML = p.daily.map((d,i) => `<input type="text" class="dailyIn" value="${d}">`).join('');
    }
    function saveEditor() {
        const i = document.getElementById('edPhaseIdx').value;
        blueprint[i] = {
            name: document.getElementById('edName').value,
            vid: document.getElementById('edVid').value,
            desc: document.getElementById('edDesc').value,
            daily: Array.from(document.querySelectorAll('.dailyIn')).map(input => input.value)
        };
        localStorage.setItem('gtr_v7_bp', JSON.stringify(blueprint));
        alert("System Updated.");
    }

    // --- VOICE ---
    const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
    function toggleVoice() {
        if(!recognition) return alert("Browser not supported");
        recognition.start();
        recognition.onresult = (e) => { document.getElementById('gearVault').value += e.results[0][0].transcript + " "; };
    }

    // INIT
    renderHeatmap();
    initEditor();
    renderGallery();
</script>
</body>
</html>
