<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Practice Lab: v10.0 Bulletproof</title>
    <style>
        :root { --bg: #020406; --glass: rgba(15, 22, 35, 0.98); --accent: #00f2ff; --secondary: #7000ff; --text: #f1f5f9; --muted: #64748b; --danger: #ff4757; --success: #2ed573; --border: rgba(0, 242, 255, 0.15); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 10px 10px 110px; overflow-x: hidden; }
        
        .container { max-width: 480px; margin: 0 auto; }
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border-radius: 20px; padding: 18px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .custom-label { font-size: 0.65rem; font-weight: 800; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        select, input, textarea { width: 100%; background: #080c14; border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 12px; font-size: 0.95rem; margin-bottom: 10px; outline: none; }
        
        /* Professional UI Buttons */
        .btn-main { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 14px; font-weight: 900; width: 100%; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-main:active { transform: scale(0.97); opacity: 0.9; }
        .btn-sub { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem; cursor: pointer; }
        .btn-rec { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 800; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Timer & Clock UI */
        .clock-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .clock-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 18px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .clock-val { font-size: 2.8rem; font-weight: 900; font-variant-numeric: tabular-nums; letter-spacing: -2px; }
        
        /* Lab Content */
        .protocol-box { background: linear-gradient(145deg, rgba(0,242,255,0.08), rgba(112,0,255,0.08)); border-radius: 15px; padding: 15px; border-left: 4px solid var(--accent); font-size: 0.85rem; line-height: 1.5; color: #cbd5e1; }
        #vPrev { width: 100%; border-radius: 15px; background: #000; transform: scaleX(-1); border: 2px solid var(--border); margin-top: 10px; }

        /* Tuner Visualization */
        .tuner-note { font-size: 5rem; font-weight: 900; color: var(--accent); text-align: center; margin: 10px 0; text-shadow: 0 0 20px rgba(0,242,255,0.3); }
        .tuner-rail { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; position: relative; overflow: hidden; }
        #needle { position: absolute; left: 50%; width: 5px; height: 100%; background: var(--accent); transition: 0.05s linear; transform: translateX(-50%); }

        /* Tabs */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: #010204; display: flex; border-top: 1px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); font-size: 0.65rem; font-weight: 800; cursor: pointer; }
        .tab-item.active { color: var(--accent); }
        
        .screen { display: none; }
        .screen.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .log-row { font-size: 0.75rem; display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div class="container">

    <div id="vault" class="screen active">
        <h2 style="margin-bottom:20px;">Performance Vault <span style="float:right; font-size:0.6rem; color:var(--accent);">v10.0</span></h2>
        
        <div class="glass-card">
            <span class="custom-label">Active 24-Week Progress</span>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="phaseSel" onchange="syncUI()"></select>
                <select id="weekSel" onchange="syncUI()"></select>
            </div>
        </div>

        <div class="glass-card">
            <span class="custom-label">Log Precision Data</span>
            <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:8px; margin-bottom:10px;">
                <select id="logType">
                    <option value="Tech Overload">Tech Overload</option>
                    <option value="Neural Warmup">Neural Warmup</option>
                    <option value="Harmonic Intel">Harmonic Intel</option>
                    <option value="Rhythmic Ctrl">Rhythmic Ctrl</option>
                </select>
                <input type="number" id="logBPM" placeholder="BPM">
            </div>
            <select id="logFail" style="margin-bottom:15px;">
                <option value="Clean">Technique: Perfect</option>
                <option value="Sync">Failed: Hand Sync</option>
                <option value="Tension">Failed: Tension</option>
                <option value="Noise">Failed: Noise</option>
            </select>
            <button class="btn-main" onclick="saveBenchmark()">LOG BENCHMARK</button>
        </div>

        <div id="benchmarkList" style="margin-top:10px;"></div>
    </div>

    <div id="lab" class="screen">
        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            Practice Lab
            <button class="btn-sub" onclick="toggleVid()">Show Video</button>
        </h2>
        
        <iframe id="labVid" src="" style="width:100%; aspect-ratio:16/9; border-radius:15px; border:none; display:none; margin-bottom:12px;"></iframe>

        <div class="glass-card">
            <div class="clock-row">
                <div class="clock-box">
                    <span class="custom-label">Timer</span>
                    <div id="tDisp" class="clock-val">00:00</div>
                    <button class="btn-sub" style="font-size:0.5rem; padding:4px;" onclick="resetT()">RESET</button>
                </div>
                <div class="clock-box">
                    <span class="custom-label" style="color:var(--secondary)">Stopwatch</span>
                    <div id="swDisp" class="clock-val" style="color:var(--secondary)">00:00</div>
                    <button class="btn-sub" style="font-size:0.5rem; padding:4px;" onclick="resetSW()">RESET</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-bottom:15px;">
                <button class="btn-sub" onclick="setT(4,'Neural Warmup')">4m</button>
                <button class="btn-sub" onclick="setT(8,'Tech Overload')">8m</button>
                <button class="btn-sub" onclick="setT(6,'Harmonic Intel')">6m</button>
                <button class="btn-sub" onclick="setT(6,'Rhythmic Ctrl')">6m</button>
            </div>
            
            <button class="btn-main" id="masterClockBtn" onclick="toggleClocks()">START PRACTICE SESSION</button>

            <div id="protocolBox" class="protocol-box" style="margin-top:15px;">
                <b>System Ready.</b> Select a training block above to view the specific mechanical protocol.
            </div>
        </div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span id="mBpmVal" style="font-weight:900; color:var(--accent);">120 BPM</span>
                <button class="btn-sub" onclick="toggleMet()" id="mBtn">METRONOME</button>
            </div>
            <input type="range" min="40" max="250" value="120" oninput="updateBpm(this.value)">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn-sub" onclick="initCamera()">OPEN LENS</button>
                <button id="recBtn" class="btn-rec" style="display:none;" onclick="handleRecording()">REC START</button>
            </div>
            <video id="vPrev" autoplay muted playsinline style="display:none;"></video>
            <div id="downloadArea" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="tuner" class="screen">
        <h2>Precision Tuner</h2>
        <div class="glass-card" style="padding: 50px 20px; text-align: center;">
            <div class="tuner-note" id="noteName">--</div>
            <div class="tuner-rail"><div id="needle"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:12px; font-size:0.6rem; color:var(--muted); font-weight:900;">
                <span>FLAT</span> <span style="color:var(--success)">IN TUNE</span> <span>SHARP</span>
            </div>
            <button class="btn-main" id="tuneBtn" style="margin-top:40px;" onclick="toggleTuner()">ACTIVATE MICROPHONE</button>
        </div>
    </div>

    <div id="config" class="screen">
        <h2>Configuration</h2>
        <div class="glass-card">
            <span class="custom-label">Edit Blueprint</span>
            <select id="edIdx" onchange="loadEditor()"></select>
            <input type="text" id="edName" placeholder="Phase Title">
            <input type="text" id="edVid" placeholder="Video Embed URL">
            <textarea id="edDesc" style="height:60px;"></textarea>
            <button class="btn-sub" style="width:100%;" onclick="saveEditor()">UPDATE PHASE</button>
        </div>
        <div class="glass-card">
            <span class="custom-label">Gear Vault & Voice Notes</span>
            <button class="btn-sub" style="width:100%; margin-bottom:10px;" onclick="startVoice()">ðŸŽ¤ DICTATE GEAR SETTINGS</button>
            <textarea id="gearNotes" style="height:150px;" placeholder="Amp settings, signal chain..."></textarea>
        </div>
    </div>

</div>

<nav class="tab-bar">
    <div class="tab-item active" onclick="nav('vault', this)">VAULT</div>
    <div class="tab-item" onclick="nav('lab', this)">LAB</div>
    <div class="tab-item" onclick="nav('tuner', this)">TUNER</div>
    <div class="tab-item" onclick="nav('config', this)">CONFIG</div>
</nav>

<script>
    // --- PROTOCOLS & DATA ---
    const protocols = {
        "Neural Warmup": "<b>Protocol:</b> Minimal Movement Principle. Focus on finger economy. Fingers should never lift more than 3mm from the string. Tempo: 50% max.",
        "Tech Overload": "<b>Protocol:</b> Boundary Training. Play 5-10 BPM above your clean limit. Focus on the physical sensation of failure to identify rhythmic bottlenecks.",
        "Harmonic Intel": "<b>Protocol:</b> Visualization. Map the modal target tones (3rds/7ths) across 3-string clusters. Improvise using only these 'anchor' notes.",
        "Rhythmic Ctrl": "<b>Protocol:</b> Displacement. Practice moving a 16th-note motif so it starts on the 'e', '&', or 'a'. Lock into the metronome's 'pocket'."
    };

    let blueprint = JSON.parse(localStorage.getItem('gtr_v10_bp')) || [
        { name: "Phase 1: Technical Foundation", vid: "https://www.youtube.com/embed/P_m9vK_m3Yc", desc: "Focus on picking depth and hand sync.", daily: ["Map 1", "Alt Pick 1", "Sync 1", "Speed 1", "Review"] },
        { name: "Phase 2: Harmonic Fluidity", vid: "https://www.youtube.com/embed/IDP_Psw0D28", desc: "Modal navigation and tonal targets.", daily: ["Dorian Path", "Mixo Flow", "Lydian Map", "Phrygian Tension", "Review"] }
    ];

    let marks = JSON.parse(localStorage.getItem('gtr_v10_marks')) || [];

    // --- NAVIGATION ---
    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(tuning && id !== 'tuner') toggleTuner();
    }

    // --- CAMERA & RECORDING ENGINE (THE FIX) ---
    let stream, recorder, chunks = [];
    async function initCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            const v = document.getElementById('vPrev');
            v.srcObject = stream; v.style.display = 'block';
            document.getElementById('recBtn').style.display = 'block';
        } catch (e) { alert("Camera Permission Denied or Not Supported."); }
    }

    function handleRecording() {
        const btn = document.getElementById('recBtn');
        if (!recorder || recorder.state === 'inactive') {
            chunks = [];
            // Select best mime type for device
            const mimeType = MediaRecorder.isTypeSupported('video/mp4') ? 'video/mp4' : 'video/webm';
            recorder = new MediaRecorder(stream, { mimeType });
            
            recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: recorder.mimeType });
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                
                // Create a persistent download button
                const area = document.getElementById('downloadArea');
                area.innerHTML = `
                    <a href="${url}" download="GuitarSession_${timestamp}.mp4" class="btn-main" 
                       style="text-decoration:none; display:block; text-align:center; background:var(--success); color:white;">
                       ðŸ’¾ SAVE LAST RECORDING
                    </a>`;
                
                // Trigger auto-download
                const a = document.createElement('a');
                a.href = url; a.download = `GuitarSession_${timestamp}.mp4`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            recorder.start();
            btn.innerText = "STOP & SAVE"; btn.style.background = "var(--secondary)";
        } else {
            recorder.stop();
            btn.innerText = "REC START"; btn.style.background = "var(--danger)";
        }
    }

    // --- LOGS & VAULT ---
    function saveBenchmark() {
        const bpm = document.getElementById('logBPM').value;
        if(!bpm) return;
        const entry = {
            week: document.getElementById('weekSel').value,
            type: document.getElementById('logType').value,
            bpm: bpm,
            fail: document.getElementById('logFail').value,
            date: new Date().toLocaleDateString()
        };
        marks.unshift(entry);
        localStorage.setItem('gtr_v10_marks', JSON.stringify(marks));
        renderMarks();
    }

    function renderMarks() {
        const list = document.getElementById('benchmarkList');
        list.innerHTML = marks.slice(0, 10).map(m => `
            <div class="log-row">
                <span><b>Wk ${m.week}</b> - ${m.type}</span>
                <span style="color:var(--accent)">${m.bpm} BPM</span>
                <span style="font-size:0.6rem; opacity:0.5;">${m.fail}</span>
            </div>
        `).join('');
    }

    // --- TUNER LOGIC ---
    let tCtx, tAnalys, tData, tStream, tuning = false;
    async function toggleTuner() {
        const btn = document.getElementById('tuneBtn');
        if(!tuning) {
            tCtx = new AudioContext();
            tStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            tCtx.createMediaStreamSource(tStream).connect(tAnalys = tCtx.createAnalyser());
            tAnalys.fftSize = 4096; tData = new Float32Array(tAnalys.frequencyBinCount);
            tuning = true; btn.innerText = "STOP TUNER"; btn.style.background = "var(--danger)";
            requestAnimationFrame(updateTuner);
        } else {
            tStream.getTracks().forEach(t => t.stop()); tCtx.close();
            tuning = false; btn.innerText = "ACTIVATE MICROPHONE"; btn.style.background = "var(--accent)";
            document.getElementById('noteName').innerText = "--";
            document.getElementById('needle').style.left = "50%";
        }
    }

    function updateTuner() {
        if(!tuning) return;
        tAnalys.getFloatFrequencyData(tData);
        let maxV = -Infinity, maxB = -1;
        for(let i=0; i<tData.length; i++) if(tData[i] > maxV) { maxV = tData[i]; maxB = i; }
        let freq = maxB * tCtx.sampleRate / tAnalys.fftSize;
        if(freq > 40 && freq < 1000 && maxV > -60) {
            let p = 12 * Math.log2(freq/440) + 69;
            let notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            document.getElementById('noteName').innerText = notes[Math.round(p)%12];
            let diff = (p - Math.round(p)) * 50;
            document.getElementById('needle').style.left = (50 + diff) + "%";
            document.getElementById('needle').style.background = Math.abs(diff) < 5 ? "var(--success)" : "var(--accent)";
        }
        requestAnimationFrame(updateTuner);
    }

    // --- CLOCKS & METRONOME ---
    let tRem = 0, swSec = 0, clockIv, running = false;
    let mCtx, mOn = false, mBpm = 120, mNext = 0, mIv;

    function setT(m, label) { tRem = m * 60; document.getElementById('protocolBox').innerHTML = protocols[label]; updateClockUI(); }
    function resetT() { tRem = 0; updateClockUI(); }
    function resetSW() { swSec = 0; updateClockUI(); }
    function toggleClocks() {
        const btn = document.getElementById('masterClockBtn');
        if(!running) {
            running = true; clockIv = setInterval(() => { if(tRem>0) tRem--; swSec++; updateClockUI(); }, 1000);
            btn.innerText = "PAUSE PRACTICE"; btn.style.background = "var(--secondary)";
        } else {
            clearInterval(clockIv); running = false;
            btn.innerText = "RESUME PRACTICE"; btn.style.background = "var(--accent)";
        }
    }
    function updateClockUI() {
        const tm=Math.floor(tRem/60), ts=tRem%60, sm=Math.floor(swSec/60), ss=swSec%60;
        document.getElementById('tDisp').innerText = `${tm}:${ts<10?'0'+ts:ts}`;
        document.getElementById('swDisp').innerText = `${sm}:${ss<10?'0'+ss:ss}`;
    }

    function toggleMet() {
        if(!mCtx) mCtx = new AudioContext();
        mOn = !mOn;
        if(mOn) { mNext = mCtx.currentTime; mTick(); document.getElementById('mBtn').innerText = "STOP"; }
        else { clearTimeout(mIv); document.getElementById('mBtn').innerText = "METRONOME"; }
    }
    function mTick() {
        while(mNext < mCtx.currentTime + 0.1) {
            const o = mCtx.createOscillator(); const g = mCtx.createGain();
            o.frequency.value = 1000; g.gain.exponentialRampToValueAtTime(1, mNext);
            g.gain.exponentialRampToValueAtTime(0.001, mNext + 0.05);
            o.connect(g); g.connect(mCtx.destination); o.start(mNext); o.stop(mNext + 0.05);
            mNext += 60 / mBpm;
        }
        mIv = setTimeout(mTick, 25);
    }
    function updateBpm(v) { mBpm = v; document.getElementById('mBpmVal').innerText = v + " BPM"; }

    // --- INITIALIZATION ---
    function syncUI() {
        const pIdx = document.getElementById('phaseSel').value;
        const p = blueprint[pIdx];
        document.getElementById('labVid').src = p.vid;
        renderMarks();
    }
    function initSelectors() {
        const ps = document.getElementById('phaseSel'), es = document.getElementById('edIdx'), ws = document.getElementById('weekSel');
        ps.innerHTML = es.innerHTML = blueprint.map((p,i) => `<option value="${i}">${p.name}</option>`).join('');
        for(let i=1; i<=24; i++) ws.innerHTML += `<option value="${i}">Week ${i}</option>`;
        loadEditor(); syncUI();
    }
    function loadEditor() {
        const p = blueprint[document.getElementById('edIdx').value];
        document.getElementById('edName').value = p.name;
        document.getElementById('edVid').value = p.vid;
        document.getElementById('edDesc').value = p.desc;
    }
    function saveEditor() {
        const i = document.getElementById('edIdx').value;
        blueprint[i] = { name: document.getElementById('edName').value, vid: document.getElementById('edVid').value, desc: document.getElementById('edDesc').value };
        localStorage.setItem('gtr_v10_bp', JSON.stringify(blueprint));
        alert("Blueprint Updated."); syncUI();
    }
    function toggleVid() { const v = document.getElementById('labVid'); v.style.display = v.style.display === 'none' ? 'block' : 'none'; }
    function startVoice() {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.start(); rec.onresult = (e) => { document.getElementById('gearNotes').value += e.results[0][0].transcript + " "; };
    }

    initSelectors();
</script>
</body>
</html>
